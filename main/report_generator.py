#!/usr/bin/env python3
"""
ğŸ“Š Ğ“Ğ•ĞĞ•Ğ ĞĞ¢ĞĞ  Ğ“Ğ›Ğ£Ğ‘ĞĞšĞ˜Ğ¥ Ğ‘Ğ˜Ğ—ĞĞ•Ğ¡-ĞĞ¢Ğ§Ğ•Ğ¢ĞĞ’
Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹ Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼Ğ¸ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸ÑĞ¼Ğ¸, Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸ÑĞ¼Ğ¸ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸
"""

import json
from datetime import datetime, timedelta
from typing import Dict, Any, List
from main.advanced_analytics import run_advanced_analysis
import sqlite3

class AdvancedReportGenerator:
    """Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ñ… Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ²"""
    
    def __init__(self):
        self.conn = sqlite3.connect('data/database.sqlite')
    
    def generate_executive_summary(self, restaurant_name: str, period_start: str = None, period_end: str = None) -> str:
        """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ ÑĞ²Ğ¾Ğ´ĞºÑƒ Ğ´Ğ»Ñ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°"""
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·
        analysis = run_advanced_analysis(restaurant_name, period_start, period_end)
        
        if "error" in analysis:
            return f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {analysis['error']}"
        
        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚
        report = self._build_executive_report(analysis)
        
        return report
    
    def _build_executive_report(self, analysis: Dict[str, Any]) -> str:
        """Ğ¡Ñ‚Ñ€Ğ¾Ğ¸Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚"""
        
        restaurant_name = analysis['restaurant_name']
        period = analysis['analysis_period']
        stats = analysis['current_stats']
        historical = analysis['historical_analysis']
        anomalies = analysis['anomalies']
        seasonality = analysis['seasonality']
        marketing = analysis['marketing_impact']
        competitive = analysis['competitive_analysis']
        insights = analysis['business_insights']
        recommendations = analysis['recommendations']
        
        report = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘                            ğŸ”¬ Ğ“Ğ›Ğ£Ğ‘ĞĞšĞ˜Ğ™ Ğ‘Ğ˜Ğ—ĞĞ•Ğ¡-ĞĞĞĞ›Ğ˜Ğ—: {restaurant_name.upper()}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“… ĞŸĞµÑ€Ğ¸Ğ¾Ğ´ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: {period}
â•‘ ğŸ• Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ Ğ˜Ğ¡ĞŸĞĞ›ĞĞ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞĞ¯ Ğ¡Ğ’ĞĞ”ĞšĞ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

        # ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
        report += f"""
ğŸ“Š ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ• ĞŸĞĞšĞĞ—ĞĞ¢Ğ•Ğ›Ğ˜ Ğ­Ğ¤Ğ¤Ğ•ĞšĞ¢Ğ˜Ğ’ĞĞĞ¡Ğ¢Ğ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’° ĞĞ±Ñ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸:           {stats['total_sales']:,.0f} IDR  
ğŸ“ˆ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ğ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸: {stats['avg_daily_sales']:,.0f} IDR
ğŸ›’ ĞĞ±Ñ‰ĞµĞµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²: {stats['total_orders']:,}
ğŸ“¦ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ğ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹:   {stats['avg_daily_orders']:.0f}
â­ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³:         {stats['avg_rating']:.2f}/5.0
ğŸšš Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸:  {stats['avg_delivery_time']:.1f} Ğ¼Ğ¸Ğ½
âŒ ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¾Ñ‚Ğ¼ĞµĞ½:           {stats['avg_cancel_rate']*100:.2f}%
ğŸ“Š Ğ’Ğ¾Ğ»Ğ°Ñ‚Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶:    {stats['sales_volatility']*100:.1f}%
"""

        # Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
        if historical.get('year_over_year'):
            yoy = historical['year_over_year']
            report += f"""
ğŸ“ˆ Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ• Ğ¡ ĞŸĞ ĞĞ¨Ğ›Ğ«Ğœ Ğ“ĞĞ”ĞĞœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’° Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶:    {yoy.get('sales_change', 0):+.1f}%
ğŸ›’ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²:   {yoy.get('orders_change', 0):+.1f}%  
â­ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ°:  {yoy.get('rating_change', 0):+.2f}
ğŸšš Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸:  {yoy.get('delivery_time_change', 0):+.1f} Ğ¼Ğ¸Ğ½
"""

        # Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ‚Ñ€ĞµĞ½Ğ´Ñ‹
        monthly_trend = historical.get('monthly_trend', {})
        report += f"""
ğŸ“Š Ğ”ĞĞ›Ğ“ĞĞ¡Ğ ĞĞ§ĞĞ«Ğ• Ğ¢Ğ Ğ•ĞĞ”Ğ« (2.5 Ğ³Ğ¾Ğ´Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ˆ Ğ¢Ñ€ĞµĞ½Ğ´ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶:      {monthly_trend.get('sales_trend', 'Ğ½/Ğ´')}
ğŸ“¦ Ğ¢Ñ€ĞµĞ½Ğ´ Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²:     {monthly_trend.get('orders_trend', 'Ğ½/Ğ´')}
â­ Ğ¢Ñ€ĞµĞ½Ğ´ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ°:    {monthly_trend.get('rating_trend', 'Ğ½/Ğ´')}
ğŸ† Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ¼ĞµÑÑÑ†:      {historical.get('peak_month', 'Ğ½/Ğ´')}
ğŸ“‰ Ğ¥ÑƒĞ´ÑˆĞ¸Ğ¹ Ğ¼ĞµÑÑÑ†:      {historical.get('worst_month', 'Ğ½/Ğ´')}
ğŸš€ Ğ Ğ¾ÑÑ‚:              {historical.get('growth_acceleration', 'Ğ½/Ğ´')}
"""

        # ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¸Ğ½ÑĞ°Ğ¹Ñ‚Ñ‹
        report += f"""
ğŸ” ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• Ğ‘Ğ˜Ğ—ĞĞ•Ğ¡-Ğ˜ĞĞ¡ĞĞ™Ğ¢Ğ«
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
        if insights:
            for insight in insights:
                report += f"â€¢ {insight}\n"
        else:
            report += "â€¢ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ½Ğµ Ğ²Ñ‹ÑĞ²Ğ¸Ğ» ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²\n"

        # ĞĞ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸ Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ¾ÑÑ‹
        report += f"""
âš¡ Ğ”Ğ•Ğ¢Ğ•ĞšĞ¢Ğ˜Ğ ĞĞ’ĞĞĞĞ«Ğ• ĞĞĞĞœĞĞ›Ğ˜Ğ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ²Ğ¾Ğ»Ğ°Ñ‚Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸: {anomalies.get('volatility_score', 0)*100:.1f}%
"""
        
        # ĞŸĞ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸
        pos_anomalies = anomalies.get('positive_anomalies', [])
        if pos_anomalies:
            report += f"\nğŸš€ Ğ¢ĞĞŸ ĞŸĞ˜ĞšĞĞ’Ğ«Ğ• Ğ”ĞĞ˜:\n"
            for i, anomaly in enumerate(pos_anomalies[:3], 1):
                date_str = anomaly['date'].strftime('%Y-%m-%d') if hasattr(anomaly['date'], 'strftime') else str(anomaly['date'])
                report += f"  {i}. {date_str}: {anomaly['total_sales']:,.0f} IDR (+{anomaly['deviation_pct']:.1f}%)\n"
        
        # ĞĞµĞ³Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸  
        neg_anomalies = anomalies.get('negative_anomalies', [])
        if neg_anomalies:
            report += f"\nğŸ“‰ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• ĞŸĞ ĞĞ’ĞĞ›Ğ«:\n"
            for i, anomaly in enumerate(neg_anomalies[:2], 1):
                date_str = anomaly['date'].strftime('%Y-%m-%d') if hasattr(anomaly['date'], 'strftime') else str(anomaly['date'])
                report += f"  {i}. {date_str}: {anomaly['total_sales']:,.0f} IDR ({anomaly['deviation_pct']:.1f}%)\n"

        # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¹
        anomaly_insights = anomalies.get('anomaly_insights', {}).get('insights', [])
        if anomaly_insights:
            report += f"\nğŸ”¬ ĞŸĞ Ğ˜Ğ§Ğ˜ĞĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ—:\n"
            for insight in anomaly_insights:
                report += f"  â€¢ {insight}\n"

        # Ğ¡ĞµĞ·Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·
        report += f"""
ğŸŒ¸ Ğ¡Ğ•Ğ—ĞĞĞĞ«Ğ• ĞŸĞĞ¢Ğ¢Ğ•Ğ ĞĞ« Ğ˜ Ğ¦Ğ˜ĞšĞ›Ğ˜Ğ§ĞĞĞ¡Ğ¢Ğ¬
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
        peak_months = seasonality.get('peak_months', [])
        if peak_months:
            report += f"ğŸ† ĞŸĞ˜ĞšĞĞ’Ğ«Ğ• ĞœĞ•Ğ¡Ğ¯Ğ¦Ğ«:\n"
            for month_data in peak_months:
                month_names = {1: 'Ğ¯Ğ½Ğ²Ğ°Ñ€ÑŒ', 2: 'Ğ¤ĞµĞ²Ñ€Ğ°Ğ»ÑŒ', 3: 'ĞœĞ°Ñ€Ñ‚', 4: 'ĞĞ¿Ñ€ĞµĞ»ÑŒ', 5: 'ĞœĞ°Ğ¹', 6: 'Ğ˜ÑĞ½ÑŒ',
                              7: 'Ğ˜ÑĞ»ÑŒ', 8: 'ĞĞ²Ğ³ÑƒÑÑ‚', 9: 'Ğ¡ĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ', 10: 'ĞĞºÑ‚ÑĞ±Ñ€ÑŒ', 11: 'ĞĞ¾ÑĞ±Ñ€ÑŒ', 12: 'Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ'}
                month_name = month_names.get(month_data['month'], f"ĞœĞµÑÑÑ† {month_data['month']}")
                report += f"  â€¢ {month_name}: {month_data['avg_sales']:,.0f} IDR/Ğ´ĞµĞ½ÑŒ\n"

        low_months = seasonality.get('low_months', [])
        if low_months:
            report += f"\nğŸ“‰ Ğ¡Ğ›ĞĞ‘Ğ«Ğ• ĞœĞ•Ğ¡Ğ¯Ğ¦Ğ«:\n"
            for month_data in low_months:
                month_names = {1: 'Ğ¯Ğ½Ğ²Ğ°Ñ€ÑŒ', 2: 'Ğ¤ĞµĞ²Ñ€Ğ°Ğ»ÑŒ', 3: 'ĞœĞ°Ñ€Ñ‚', 4: 'ĞĞ¿Ñ€ĞµĞ»ÑŒ', 5: 'ĞœĞ°Ğ¹', 6: 'Ğ˜ÑĞ½ÑŒ',
                              7: 'Ğ˜ÑĞ»ÑŒ', 8: 'ĞĞ²Ğ³ÑƒÑÑ‚', 9: 'Ğ¡ĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ', 10: 'ĞĞºÑ‚ÑĞ±Ñ€ÑŒ', 11: 'ĞĞ¾ÑĞ±Ñ€ÑŒ', 12: 'Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ'}
                month_name = month_names.get(month_data['month'], f"ĞœĞµÑÑÑ† {month_data['month']}")
                report += f"  â€¢ {month_name}: {month_data['avg_sales']:,.0f} IDR/Ğ´ĞµĞ½ÑŒ\n"

        weekly_pattern = seasonality.get('weekly_pattern', {})
        if weekly_pattern:
            days_names = ['ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº', 'Ğ’Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº', 'Ğ¡Ñ€ĞµĞ´Ğ°', 'Ğ§ĞµÑ‚Ğ²ĞµÑ€Ğ³', 'ĞŸÑÑ‚Ğ½Ğ¸Ñ†Ğ°', 'Ğ¡ÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°', 'Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ']
            weekend_boost = weekly_pattern.get('weekend_boost', 0)
            best_day = weekly_pattern.get('best_day', 0)
            worst_day = weekly_pattern.get('worst_day', 0)
            
            report += f"""
ğŸ“… ĞĞ•Ğ”Ğ•Ğ›Ğ¬ĞĞ«Ğ• ĞŸĞĞ¢Ğ¢Ğ•Ğ ĞĞ«:
  â€¢ Ğ­Ñ„Ñ„ĞµĞºÑ‚ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½Ñ‹Ñ…: {weekend_boost:+.1f}%
  â€¢ Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ: {days_names[best_day] if 0 <= best_day < 7 else 'Ğ½/Ğ´'}
  â€¢ Ğ¥ÑƒĞ´ÑˆĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ: {days_names[worst_day] if 0 <= worst_day < 7 else 'Ğ½/d'}
"""

        # ĞœĞ°Ñ€ĞºĞµÑ‚Ğ¸Ğ½Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ
        report += f"""
ğŸ“¢ ĞĞĞĞ›Ğ˜Ğ— ĞœĞĞ ĞšĞ•Ğ¢Ğ˜ĞĞ“ĞĞ’ĞĞ™ Ğ­Ğ¤Ğ¤Ğ•ĞšĞ¢Ğ˜Ğ’ĞĞĞ¡Ğ¢Ğ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
        if not marketing.get('error'):
            report += f"""ğŸ“ˆ ĞŸĞ¾Ğ´ÑŠĞµĞ¼ Ğ¾Ñ‚ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹:      {marketing.get('marketing_lift', 0):.1f}%
ğŸ’° Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ ROAS:           {marketing.get('avg_roas', 0):.1f}
ğŸ† Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹ ROAS:            {marketing.get('best_roas', 0):.1f}
ğŸ“‰ Ğ¥ÑƒĞ´ÑˆĞ¸Ğ¹ ROAS:            {marketing.get('worst_roas', 0):.1f}
ğŸ“Š Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° ĞºĞ°Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹:       {marketing.get('campaign_frequency', 0):.1f}% Ğ´Ğ½ĞµĞ¹
"""
            
            optimal_days = marketing.get('optimal_days', {})
            if optimal_days and not optimal_days.get('message'):
                report += f"""
ğŸ¯ ĞĞŸĞ¢Ğ˜ĞœĞĞ›Ğ¬ĞĞĞ¯ Ğ¡Ğ¢Ğ ĞĞ¢Ğ•Ğ“Ğ˜Ğ¯:
  â€¢ Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ´Ğ»Ñ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹: {optimal_days.get('best_day', 'Ğ½/Ğ´')} (ROAS {optimal_days.get('best_roas', 0):.1f})
  â€¢ Ğ˜Ğ·Ğ±ĞµĞ³Ğ°Ñ‚ÑŒ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹: {optimal_days.get('worst_day', 'Ğ½/d')} (ROAS {optimal_days.get('worst_roas', 0):.1f})
"""
        else:
            report += f"âš ï¸ {marketing['error']}\n"

        # ĞšĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·
        report += f"""
ğŸ¥Š ĞšĞĞĞšĞ£Ğ Ğ•ĞĞ¢ĞĞĞ¯ ĞŸĞĞ—Ğ˜Ğ¦Ğ˜Ğ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ† ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ½Ğ° Ñ€Ñ‹Ğ½ĞºĞµ:       #{competitive.get('market_position', 'Ğ½/d')} Ğ¸Ğ· 5
ğŸ“Š Ğ”Ğ¾Ğ»Ñ Ñ€Ñ‹Ğ½ĞºĞ°:             {competitive.get('market_share', 0):.1f}%
ğŸ‘‘ Ğ›Ğ¸Ğ´ĞµÑ€ Ñ€Ñ‹Ğ½ĞºĞ°:            {competitive.get('market_leader', 'Ğ½/d')}
"""
        
        competitive_gap = competitive.get('competitive_gap')
        if competitive_gap is not None:
            report += f"ğŸ“ ĞÑ‚ÑÑ‚Ğ°Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚ Ğ»Ğ¸Ğ´ĞµÑ€Ğ°:   {competitive_gap:.1f}%\n"

        # Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸
        report += f"""
ğŸ’¡ Ğ¡Ğ¢Ğ ĞĞ¢Ğ•Ğ“Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• Ğ Ğ•ĞšĞĞœĞ•ĞĞ”ĞĞ¦Ğ˜Ğ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"""
        if recommendations:
            for i, rec in enumerate(recommendations, 1):
                report += f"{i}. {rec}\n"
        else:
            report += "â€¢ Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹\n"

        # ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸
        trend_forecast = analysis.get('trend_forecast', {})
        report += f"""
ğŸ”® ĞŸĞ ĞĞ“ĞĞĞ— Ğ˜ Ğ¡Ğ›Ğ•Ğ”Ğ£Ğ®Ğ©Ğ˜Ğ• Ğ¨ĞĞ“Ğ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ˆ ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞ½Ğ´Ğ°:     {trend_forecast.get('trend_direction', 'Ğ½/d')}
ğŸ’ª Ğ¡Ğ¸Ğ»Ğ° Ñ‚Ñ€ĞµĞ½Ğ´Ğ°:            {trend_forecast.get('trend_strength', 0):.1f}%/Ğ¼ĞµÑÑÑ†
ğŸ“Š ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ Ñ€Ğ¾ÑÑ‚:          {trend_forecast.get('monthly_growth_rate', 0):,.0f} IDR

ğŸ¯ ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ĞĞ«Ğ• Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ¯:
"""
        
        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
        priorities = self._generate_action_priorities(analysis)
        for i, priority in enumerate(priorities, 1):
            report += f"  {i}. {priority}\n"

        report += f"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        ğŸ“Š ĞšĞĞĞ•Ğ¦ ĞĞĞĞ›Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ“Ğ ĞĞ¢Ğ§Ğ•Ğ¢Ğ
                  ğŸ”¬ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµĞ»Ğ° Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· 2.5 Ğ»ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
              ğŸ’¡ Ğ’ÑĞµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ½Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ğ¼Ñ‹Ñ… Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ°Ñ…
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

        return report
    
    def _generate_action_priorities(self, analysis: Dict[str, Any]) -> List[str]:
        """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°"""
        
        priorities = []
        stats = analysis['current_stats']
        marketing = analysis['marketing_impact']
        competitive = analysis['competitive_analysis']
        historical = analysis['historical_analysis']
        
        # ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶
        yoy = historical.get('year_over_year', {})
        if yoy.get('sales_change', 0) < -15:
            priorities.append("ğŸ†˜ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ: ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶ - Ğ¿Ñ€Ğ¾Ğ²ĞµÑÑ‚Ğ¸ emergency-Ğ°ÑƒĞ´Ğ¸Ñ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹")
        
        # Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¸Ğ½Ğ³
        if marketing.get('marketing_lift', 0) > 30 and marketing.get('avg_roas', 0) > 4:
            priorities.append("ğŸ“¢ Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™: ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğµ ĞºĞ°Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸")
        
        # Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: ĞºĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
        if competitive.get('market_position', 1) > 2:
            priorities.append("ğŸ¯ Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™: Ğ˜Ğ·ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ² Ñ€Ñ‹Ğ½ĞºĞ° Ğ¸ Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»ÑƒÑ‡ÑˆĞ¸Ğµ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¸")
        
        # Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ
        if stats.get('avg_rating', 5) < 4.2:
            priorities.append("â­ Ğ¡Ğ Ğ•Ğ”ĞĞ˜Ğ™: Ğ£Ğ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞµĞ½Ğ¸Ñ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ°")
        
        if stats.get('avg_delivery_time', 0) > 30:
            priorities.append("ğŸšš Ğ¡Ğ Ğ•Ğ”ĞĞ˜Ğ™: ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ´Ğ»Ñ ÑĞ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸")
        
        # ĞĞ¸Ğ·ĞºĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³
        priorities.append("ğŸ“Š ĞĞ˜Ğ—ĞšĞ˜Ğ™: Ğ’Ğ½ĞµĞ´Ñ€Ğ¸Ñ‚ÑŒ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº")
        
        return priorities[:5]  # Ğ¢Ğ¾Ğ¿-5 Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ¾Ğ²
    
    def generate_market_overview(self) -> str:
        """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ğ±Ğ·Ğ¾Ñ€ Ğ²ÑĞµĞ³Ğ¾ Ñ€Ñ‹Ğ½ĞºĞ° Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ¾Ğ²"""
        
        cursor = self.conn.cursor()
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ¾Ğ²
        cursor.execute('SELECT name FROM restaurants ORDER BY name')
        restaurants = [row[0] for row in cursor.fetchall()]
        
        # ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 90 Ğ´Ğ½ĞµĞ¹
        latest_date_query = 'SELECT MAX(date) FROM restaurant_data'
        cursor.execute(latest_date_query)
        latest_date = cursor.fetchone()[0]
        
        if not latest_date:
            return "âŒ ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ€Ñ‹Ğ½ĞºĞ°"
        
        latest_date = datetime.strptime(latest_date, '%Y-%m-%d')
        three_months_ago = latest_date - timedelta(days=90)
        
        report = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘                              ğŸ“Š ĞĞ‘Ğ—ĞĞ  Ğ Ğ«ĞĞšĞ Ğ Ğ•Ğ¡Ğ¢ĞĞ ĞĞĞĞ’ Ğ‘ĞĞ›Ğ˜
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“… ĞŸĞµÑ€Ğ¸Ğ¾Ğ´: ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 90 Ğ´Ğ½ĞµĞ¹ ({three_months_ago.strftime('%Y-%m-%d')} - {latest_date.strftime('%Y-%m-%d')})
â•‘ ğŸ• Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ† Ğ Ğ•Ğ™Ğ¢Ğ˜ĞĞ“ Ğ Ğ•Ğ¡Ğ¢ĞĞ ĞĞĞĞ’ ĞŸĞ ĞŸĞ ĞĞ”ĞĞ–ĞĞœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
        
        # ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ğ¾ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°Ğ¼
        for i, restaurant in enumerate(restaurants, 1):
            try:
                analysis = run_advanced_analysis(restaurant, three_months_ago.strftime('%Y-%m-%d'), latest_date.strftime('%Y-%m-%d'))
                
                if "error" not in analysis:
                    stats = analysis['current_stats']
                    competitive = analysis['competitive_analysis']
                    
                    report += f"""
{i}. ğŸª {restaurant.upper()}
   ğŸ’° ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸: {stats['total_sales']:,.0f} IDR | ğŸ“¦ Ğ—Ğ°ĞºĞ°Ğ·Ñ‹: {stats['total_orders']:,} | â­ Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³: {stats['avg_rating']:.2f}
   ğŸ“Š Ğ”Ğ¾Ğ»Ñ Ñ€Ñ‹Ğ½ĞºĞ°: {competitive.get('market_share', 0):.1f}% | ğŸšš Ğ”Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ°: {stats['avg_delivery_time']:.1f} Ğ¼Ğ¸Ğ½
"""
            except Exception as e:
                report += f"\n{i}. ğŸª {restaurant.upper()} - âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: {str(e)}\n"
        
        report += f"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                    ğŸ“Š ĞšĞĞĞ•Ğ¦ ĞĞ‘Ğ—ĞĞ Ğ Ğ Ğ«ĞĞšĞ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
        
        return report
    
    def close(self):
        """Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ±Ğ°Ğ·Ğ¾Ğ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
        self.conn.close()

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
def generate_restaurant_report(restaurant_name: str, period_start: str = None, period_end: str = None) -> str:
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ´Ğ»Ñ Ñ€ĞµÑÑ‚Ğ¾Ñ€Ğ°Ğ½Ğ°"""
    generator = AdvancedReportGenerator()
    try:
        return generator.generate_executive_summary(restaurant_name, period_start, period_end)
    finally:
        generator.close()

def generate_market_report() -> str:
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ğ±Ğ·Ğ¾Ñ€ Ñ€Ñ‹Ğ½ĞºĞ°"""
    generator = AdvancedReportGenerator()
    try:
        return generator.generate_market_overview()
    finally:
        generator.close()

if __name__ == "__main__":
    # Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    print("ğŸ§ª Ğ¢ĞµÑÑ‚ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°...")
    report = generate_restaurant_report("Ika Canggu")
    print("âœ… ĞÑ‚Ñ‡ĞµÑ‚ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾")